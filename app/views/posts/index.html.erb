<p id="notice"><%= notice %></p>

<h1 class="mb-4">ポイ活サイト一覧</h1>


<%= form_with url: posts_path, method: :get, local: true do %>
  <!-- 投稿検索 -->
  <%= text_field_tag :query, params[:query], placeholder:"キーワードを入力" %>

  <!-- ポイント還元率の検索用 -->
  <%= select_tag :reward_rate, options_for_select([
      ['すべて', ''],
      ['高還元率（1%以上）', '高還元率（1%以上）'],
      ['中還元率（0.5%〜1%）', '中還元率（0.5%〜1%）'],
      ['低還元率（0.5%未満）', '低還元率（0.5%未満）']
    ], params[:reward_rate])
  %>

  <!-- タグ検索 -->
  <%= text_field_tag :tag, params[:tag], placeholder:"関連キーワード(タグ)を入力" %>

  <%= submit_tag "検索" %>
<% end %>

<table class="table">
  <thead>
    <tr>
      <th>投稿者</th>
      <th>サービス名</th>
      <th>サービスの特徴や使いやすさ</th>
      <th>ポイント還元率</th>
      <th>関連キーワード（タグ）</th>
      <th>いいね機能</th> 
      <th>評価（5段階）</th> 
      <th></th>
    </tr>
  </thead>

  <tbody>
    <% @posts.each do |post| %>
      <tr>
        <td><%= post.user.name %></td>
        <td><%= post.title %></td>
        <td><%= post.body %></td>
        <td><%= post.reward_rate.presence || "未設定" %></td>

        <!-- 投稿検索機能(タグ検索) -->
        <td>
          <% post.tag_list.each do |tag| %>
            <%= link_to tag, posts_path(tag: tag) %>
          <% end %>
        </td>

        <td>
          <% if post.favorited_by?(current_user) %>
            <%= link_to post_favorite_path(post), method: :delete, data: { turbo_method: :delete } do %>
              ♥<%= post.favorites.count %> いいね
            <% end %>
          <% else %>
            <%= link_to post_favorite_path(post), method: :post, data: { turbo_method: :post } do %>
              ♡<%= post.favorites.count %> いいね
            <% end %>
          <% end %>
        </td>

        <td>
          <div id="post_raty_<%= post.id %>"></div>
        <script>
          (function() {  
            const elem = document.querySelector("#post_raty_<%= post.id %>");
            const opt = {
              starHalf: "/assets/star-half.png",
              starOff: "/assets/star-off.png",
              starOn: "/assets/star-on.png",
              readOnly: true,
              score: <%= post.rate || 0 %>
            };
            raty(elem, opt);
          })();
        </script>

        <td>
          <%= link_to '詳細を見る', post %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<br>

<% if current_user.email != 'guest@example.com' %>
  <div>
    <%= link_to 'おすすめなポイ活サイトを投稿(新規投稿)', new_post_path %>
  </div>
<% end %>
